name: Room Assignment Automation

on:
  schedule:
    # Calcul quotidien √† 18h00 pour toutes les √©coles
    - cron: '0 18 * * *'
    # V√©rification des notifications toutes les 5 minutes
    - cron: '*/5 * * * *'
    # Nettoyage hebdomadaire (dimanche √† 3h00)
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Mode execution'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - calculate-only
          - notify-only
          - cleanup-only

jobs:
  # ============================================================
  # JOB 1: Calcul des attributions pour TOUTES les √©coles
  # ============================================================
  calculate-assignments:
    runs-on: ubuntu-latest
    if: |
      (github.event.schedule == '0 18 * * *') || 
      (github.event_name == 'workflow_dispatch' && (inputs.mode == 'all' || inputs.mode == 'calculate-only'))
    
    steps:
      - name: Calculer les attributions pour toutes les √©coles
        run: |
          echo "üìÖ Date de calcul: $(date -d '+1 day' +%Y-%m-%d)"
          echo "üîÑ Lancement du calcul multi-√©coles..."
          
          RESPONSE=$(curl -s -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/rpc/calculate_room_assignments_all_schools_rpc" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"p_session_date\": \"$(date -d '+1 day' +%Y-%m-%d)\"
            }")
          
          echo "‚úÖ R√©sultat:"
          echo "$RESPONSE" | jq .
          
          # V√©rifier s'il y a des erreurs
          SCHOOLS_FAILED=$(echo "$RESPONSE" | jq -r '.schools_failed // 0')
          if [ "$SCHOOLS_FAILED" -gt 0 ]; then
            echo "‚ö†Ô∏è Attention: $SCHOOLS_FAILED √©cole(s) en erreur"
            exit 1
          fi

  # ============================================================
  # JOB 2: Notifications T-60 (1h avant) pour TOUTES les √©coles
  # ============================================================
  notify-t60:
    runs-on: ubuntu-latest
    if: |
      (github.event.schedule == '*/5 * * * *') || 
      (github.event_name == 'workflow_dispatch' && (inputs.mode == 'all' || inputs.mode == 'notify-only'))
    
    steps:
      - name: Envoyer les notifications T-60min
        run: |
          echo "‚è∞ Fen√™tre T-60: $(date +%Y-%m-%d)"
          echo "üîÑ Envoi des rappels pour toutes les √©coles..."
          
          RESPONSE=$(curl -s -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/rpc/send_room_assignment_notifications_all_schools_rpc" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"p_notification_window\": 60,
              \"p_session_date\": \"$(date +%Y-%m-%d)\"
            }")
          
          echo "‚úÖ R√©sultat T-60:"
          echo "$RESPONSE" | jq .

  # ============================================================
  # JOB 3: Notifications T-15 (15min avant) pour TOUTES les √©coles
  # ============================================================
  notify-t15:
    runs-on: ubuntu-latest
    if: |
      (github.event.schedule == '*/5 * * * *') || 
      (github.event_name == 'workflow_dispatch' && (inputs.mode == 'all' || inputs.mode == 'notify-only'))
    
    steps:
      - name: Envoyer les notifications T-15min
        run: |
          echo "‚è∞ Fen√™tre T-15: $(date +%Y-%m-%d)"
          echo "üîÑ Envoi des rappels pour toutes les √©coles..."
          
          RESPONSE=$(curl -s -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/rpc/send_room_assignment_notifications_all_schools_rpc" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"p_notification_window\": 15,
              \"p_session_date\": \"$(date +%Y-%m-%d)\"
            }")
          
          echo "‚úÖ R√©sultat T-15:"
          echo "$RESPONSE" | jq .

  # ============================================================
  # JOB 4: Nettoyage hebdomadaire
  # ============================================================
  cleanup:
    runs-on: ubuntu-latest
    if: |
      (github.event.schedule == '0 3 * * 0') || 
      (github.event_name == 'workflow_dispatch' && inputs.mode == 'cleanup-only')
    
    steps:
      - name: Nettoyer les anciennes attributions
        run: |
          echo "üßπ Nettoyage des attributions de plus de 30 jours..."
          
          RESPONSE=$(curl -s -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/rpc/cleanup_old_room_assignments_all_schools_rpc" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "p_days_to_keep": 30
            }')
          
          echo "‚úÖ R√©sultat nettoyage:"
          echo "$RESPONSE" | jq .
